---
title: "Rhododendron_Fungal_Ecology"
author: "Tomas Byrne"
output: html_document
date: "2025-09-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
gert::git_add(".")
#gert::git_commit("Update project files")
gert::git_push()
```

## R Markdown

Analysis scripts for a reseach paper focusing on Fungal Ecology of Rhododendron ponticium
There are 4 sites from around Ireland.
Initial analysis was done on the HPC to extract, clean and classify sequences using qiime. 

```{r}
##Step1: Build a phyloseq object
#Load packages
library(phyloseq)
library(Biostrings)
library(data.table)
#Read feature table
feature_table_ITS <- fread("Y:/Tomas Byrne/1_Research/2024_Rponticum_Botanics/Paper/QiimeOutputs/feature-table.tsv", skip = 1)
feature_ids_ITS <- feature_table_ITS[[1]]
otu_matrix_ITS <- as.matrix(feature_table_ITS[, -1, with = FALSE])
rownames(otu_matrix_ITS) <- feature_ids_ITS

# Remove "I_" prefix from sample names
colnames(otu_matrix_ITS) <- gsub("^E_", "", colnames(otu_matrix_ITS))

# Create otu_table
otu_table_physeq_ITS <- otu_table(otu_matrix_ITS, taxa_are_rows = TRUE)

# Load taxonomy with header and full data
taxonomy_ITS <- read.delim("Y:/Tomas Byrne/1_Research/2024_Rponticum_Botanics/Paper/QiimeOutputs/taxonomy.tsv", header = TRUE, sep = "\t", comment.char = "")

# Set rownames to the Feature ID column
rownames(taxonomy_ITS ) <- taxonomy_ITS $Feature.ID

# Ensure Taxon column is character for string splitting
taxonomy_ITS $Taxon <- as.character(taxonomy_ITS $Taxon)

# Split taxonomy into ranks
tax_split_ITS  <- strsplit(taxonomy_ITS $Taxon, ";\\s*")  # splits by "; " with optional extra whitespace

# Pad any shorter taxonomic paths to length 7 (for standard ranks)
tax_mat_ITS  <- do.call(rbind, lapply(tax_split_ITS , function(x) {
  length(x) <- 7  # pad to 7 levels (K, P, C, O, F, G, S)
  return(x)
}))

# Set proper column and row names
colnames(tax_mat_ITS ) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
rownames(tax_mat_ITS ) <- taxonomy_ITS $Feature.ID

# Read in DNA seqs
dna_ITS <- readDNAStringSet("Y:/Tomas Byrne/1_Research/2024_Rponticum_Botanics/Paper/QiimeOutputs/dna-sequences.fasta")
names(dna_ITS) <- sub(" .*", "", names(dna_ITS))  # Remove sample names from sequence IDs

# ensure every entry is character:
tax_mat_ITS <- matrix(
  as.character(tax_mat_ITS),
  nrow = nrow(tax_mat_ITS),
  dimnames = dimnames(tax_mat_ITS)
)

# now create tax_table
tax_table_physeq_ITS <- tax_table(tax_mat_ITS)

metadata_ITS <- read.csv("Y:/Tomas Byrne/1_Research/2024_Rponticum_Botanics/Paper/QiimeOutputs/metadata.csv",
                         header = TRUE,
                         stringsAsFactors = FALSE)

# ---- Harmonise sample IDs ---------------------------------------------------
# Which column in metadata holds the machine/analysis IDs like "sa1" ?
# Try "Sample_ID" first, fall back to "SampleID"
id_col <- if ("Sample_ID" %in% names(metadata_ITS)) "Sample_ID" else "SampleID"

# If your OTU columns had an "E_" prefix removed, do the same to the metadata IDs
metadata_ITS[[id_col]] <- gsub("^E_", "", metadata_ITS[[id_col]])

# Set metadata rownames to those IDs and (optionally) keep a human-readable label
rownames(metadata_ITS) <- metadata_ITS[[id_col]]
names(metadata_ITS)[names(metadata_ITS) == id_col] <- "SampleCode"  # keep it as a variable

# (Optional) sanity checks
otu_ids  <- colnames(otu_matrix_ITS)
meta_ids <- rownames(metadata_ITS)
cat("In OTU not in metadata:\n"); print(setdiff(otu_ids,  meta_ids))
cat("In metadata not in OTU:\n"); print(setdiff(meta_ids, otu_ids))

# Keep only the intersection (prevents empty merges)
keep <- intersect(otu_ids, meta_ids)
otu_matrix_ITS <- otu_matrix_ITS[, keep, drop = FALSE]
metadata_ITS   <- metadata_ITS[keep, , drop = FALSE]

# ---- Rebuild phyloseq cleanly ----------------------------------------------
otu_table_physeq_ITS <- otu_table(otu_matrix_ITS, taxa_are_rows = TRUE)
tax_table_physeq_ITS <- tax_table(tax_mat_ITS)
sample_data_physeq_ITS <- sample_data(metadata_ITS)

ps_ITS <- phyloseq(otu_table_physeq_ITS, tax_table_physeq_ITS, sample_data_physeq_ITS)

# keep only sequences whose IDs match ASV/taxa names in ps_ITS
dna_sub <- dna_ITS[names(dna_ITS) %in% taxa_names(ps_ITS)]

# attach as refseq via merge
ps_ITS <- merge_phyloseq(ps_ITS, dna_sub)

# Final check
sample_names(ps_ITS)[1:10]


```



